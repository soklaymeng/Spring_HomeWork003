pipeline {
    agent any
    environment {
        DOCKER_IMAGE = "mengsoklay/deops-backend:${env.BUILD_ID}"
        DOCKER_CREDENTIALS_ID = 'dockerhub-token'
        GIT_CREDENTIALS_ID = 'git-token'
        MANIFEST_REPO = "https://github.com/soklaymeng/argro-spring.git"
        MANIFEST_FILE_PATH = "path/to/your/manifest/file.yaml"
        GIT_BRANCH = "main"  // Adjust if needed
    }
    
    stages {
        stage("Checkout Code") {
            steps {
                git branch: 'master', url: 'https://github.com/soklaymeng/Spring_HomeWork003.git'
            }
        }

        stage("Build and Push Docker Image") {
            steps {
                script {
                    echo "Building Spring Boot Docker image"
                    sh "docker build -t ${DOCKER_IMAGE} ."

                    echo "Pushing Docker image to Docker Hub"
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')]) {
                        sh "echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin"
                        sh "docker push ${DOCKER_IMAGE}"
                    }
                }
            }
        }

        stage("Update Kubernetes Manifest") {
            steps {
                script {
                    echo "Cloning manifest repository"
                    withCredentials([usernamePassword(credentialsId: GIT_CREDENTIALS_ID, passwordVariable: 'GIT_PASS', usernameVariable: 'GIT_USER')]) {
                        sh """
                            git clone ${MANIFEST_REPO} manifest-repo
                            cd manifest-repo
                            git checkout ${GIT_BRANCH}
                        """

                        echo "Updating manifest file with new Docker image"
                        sh """
                            sed -i 's|image:.*|image: ${DOCKER_IMAGE}|' manifest-repo/${MANIFEST_FILE_PATH}
                            cd manifest-repo
                            git config user.email "mengsoklay2222@gmail.com"
                            git config user.name "soklaymeng"
                            git add ${MANIFEST_FILE_PATH}
                            git commit -m 'Update image to ${DOCKER_IMAGE}'
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/soklaymeng/argro-spring.git ${GIT_BRANCH}
                        """
                    }
                }
            }
        }
    }
}
